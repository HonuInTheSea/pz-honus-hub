<p-toast position="top-center"></p-toast>
<div class="p-3">
  <p-card #serversCard [header]="'server.ui.serversHeader' | transloco">
    <div class="flex justify-content-between align-items-center gap-2">
      <div></div>
      <div class="flex gap-2">
        <button pButton type="button" [label]="'server.ui.refresh' | transloco" class="p-button-text" icon="pi pi-refresh" (click)="refreshServerList()"></button>
        <button pButton type="button" [label]="'server.ui.createNewServer' | transloco" icon="pi pi-plus" (click)="openCreateDialog()"></button>
        <button pButton type="button" [label]="'server.ui.copy' | transloco" class="pz-copy-button" icon="pi pi-copy" [disabled]="!selectedServerName" (click)="openCopyDialog()"></button>
        <button pButton type="button" [label]="'server.ui.exportServer' | transloco" class="p-button-info" icon="pi pi-upload" [disabled]="!selectedServerName" (click)="exportServerFiles()"></button>
        <button pButton type="button" [label]="'server.ui.deleteServer' | transloco" class="p-button-danger" icon="pi pi-trash" [disabled]="!selectedServerName" (click)="openDeleteDialog()"></button>
      </div>
    </div>
    <div class="mt-3">
      @if (!serverNames.length) {
        <p class="m-0 text-color-secondary">{{ 'server.ui.noServerFiles' | transloco }}</p>
      } @else {
        <p-select
          #serverSelect
          [options]="serverNames"
          [(ngModel)]="selectedServerName"
          [placeholder]="'server.ui.selectServerPlaceholder' | transloco"
          [style.width.px]="serverSelectWidth"
          (ngModelChange)="selectServer($event)"
        ></p-select>
      }
    </div>
    @if (!selectedServerName) {
      <div class="mt-3">
        <div class="text-lg font-medium">{{ 'server.ui.serverEditor' | transloco }}</div>
        <p class="m-0 text-color-secondary mt-1">{{ 'server.ui.selectServerPrompt' | transloco }}</p>
      </div>
    }
  </p-card>

  <div class="mt-3">
    <div class="w-full mt-3">
      <p-card>
        @if (selectedServerName) {
          <p-tabs value="ini" (valueChange)="onTabChange($event)">
            <p-tablist>
              <p-tab value="ini">{{ 'server.ui.tabs.ini' | transloco }}</p-tab>
              <p-tab value="sandbox">{{ 'server.ui.tabs.sandbox' | transloco }}</p-tab>
              <p-tab value="spawnpoints">{{ 'server.ui.tabs.spawnpoints' | transloco }}</p-tab>
              <p-tab value="spawnregions">{{ 'server.ui.tabs.spawnregions' | transloco }}</p-tab>
            </p-tablist>
            <p-tabpanels>
              <p-tabpanel value="ini">
                @if (!iniLines.length) {
                  <p class="m-0 text-color-secondary">{{ 'server.ui.noIniEntries' | transloco }}</p>
                  } @else {
                    <label class="text-sm text-color-secondary block w-full mb-2">{{ 'server.ui.serverConfigVars' | transloco }}</label>
                    <div #iniListboxHost class="flex-1 min-h-0 w-full">
                      <p-listbox
                        [options]="iniEntryOptions"
                        optionLabel="label"
                        optionValue="key"
                        [filter]="true"
                        [style.height]="iniListboxHeight"
                        [scrollHeight]="iniListboxScrollHeight"
                        [focusOnHover]="false"
                        [autoOptionFocus]="false"
                        [selectOnFocus]="true"
                        [metaKeySelection]="false"
                        [(ngModel)]="selectedIniKey"
                        (onChange)="onIniEntrySelect($event.value)"
                        (onClick)="onIniEntryClick($event)"
                        dataKey="key"
                      >
                        <ng-template let-item pTemplate="item">
                          <div
                            class="flex align-items-center"
                            [class.text-primary]="isIniValueChanged(item.key, getIniValueByKey(item.key))"
                          >
                            {{ item.label }}
                          </div>
                        </ng-template>
                      </p-listbox>
                    </div>
                    <div #iniActions class="flex justify-content-end gap-2 mt-3">
                      <button
                        pButton
                        type="button"
                        [label]="'server.ui.reset' | transloco"
                        class="p-button-text"
                        [disabled]="!isIniDirty"
                        (click)="resetIniChanges()"
                      ></button>
                      <button
                        pButton
                        type="button"
                        [label]="'server.ui.saveChanges' | transloco"
                        icon="pi pi-save"
                        [loading]="savingIni"
                        [disabled]="!isIniDirty"
                        (click)="saveIniChanges()"
                      ></button>
                    </div>
                  
                }
              </p-tabpanel>
              <p-tabpanel value="sandbox">
                @if (!sandboxEntryOptions.length) {
                  <p class="m-0 text-color-secondary">{{ 'server.ui.noSandboxEntries' | transloco }}</p>
                } @else {
                  <label class="text-sm text-color-secondary block w-full mb-2">{{ 'server.ui.sandboxVariables' | transloco }}</label>
                  <div #sandboxListboxHost class="flex-1 min-h-0 w-full">
                    <p-listbox
                      [options]="sandboxEntryOptions"
                      optionLabel="label"
                      optionValue="id"
                      [filter]="true"
                      [style.height]="sandboxListboxHeight"
                      [scrollHeight]="sandboxListboxScrollHeight"
                      [focusOnHover]="false"
                      [autoOptionFocus]="false"
                      [selectOnFocus]="true"
                      [metaKeySelection]="false"
                      [(ngModel)]="selectedSandboxKey"
                      (onChange)="onSandboxEntrySelect($event.value)"
                      (onClick)="onSandboxEntryClick($event)"
                      dataKey="id"
                    >
                      <ng-template let-item pTemplate="item">
                        <div
                          class="flex align-items-center"
                          [class.text-primary]="isSandboxValueChanged(item.id, item.value)"
                        >
                          {{ item.label }}
                        </div>
                      </ng-template>
                    </p-listbox>
                  </div>
                }
                <div #sandboxActions class="flex justify-content-end gap-2 mt-3">
                  <button
                    pButton
                    type="button"
                    [label]="'server.ui.reset' | transloco"
                    class="p-button-text"
                    [disabled]="!isSandboxDirty"
                    (click)="resetSandboxChanges()"
                  ></button>
                  <button
                    pButton
                    type="button"
                    [label]="'server.ui.saveChanges' | transloco"
                    icon="pi pi-save"
                    [loading]="savingSandbox"
                    [disabled]="!isSandboxDirty"
                    (click)="saveSandboxChanges()"
                  ></button>
                </div>
              </p-tabpanel>
              <p-tabpanel value="spawnpoints">
                <textarea
                  #spawnpointsTextarea
                  pTextarea
                  [(ngModel)]="spawnpointsText"
                  class="w-full"
                  [style.height]="spawnpointsTextareaHeight"
                  style="font-family: var(--font-family-monospace, monospace)"
                ></textarea>
                <div #spawnpointsActions class="flex justify-content-end gap-2 mt-3">
                  <button
                    pButton
                    type="button"
                    [label]="'server.ui.reset' | transloco"
                    class="p-button-text"
                    [disabled]="!isSpawnpointsDirty"
                    (click)="resetSpawnpointsChanges()"
                  ></button>
                  <button
                    pButton
                    type="button"
                    [label]="'server.ui.saveChanges' | transloco"
                    icon="pi pi-save"
                    [loading]="savingSpawnpoints"
                    [disabled]="!isSpawnpointsDirty"
                    (click)="saveSpawnpointsChanges()"
                  ></button>
                </div>
              </p-tabpanel>
              <p-tabpanel value="spawnregions">
                <textarea
                  #spawnregionsTextarea
                  pTextarea
                  [(ngModel)]="spawnregionsText"
                  class="w-full"
                  [style.height]="spawnregionsTextareaHeight"
                  style="font-family: var(--font-family-monospace, monospace)"
                ></textarea>
                <div #spawnregionsActions class="flex justify-content-end gap-2 mt-3">
                  <button
                    pButton
                    type="button"
                    [label]="'server.ui.reset' | transloco"
                    class="p-button-text"
                    [disabled]="!isSpawnregionsDirty"
                    (click)="resetSpawnregionsChanges()"
                  ></button>
                  <button
                    pButton
                    type="button"
                    [label]="'server.ui.saveChanges' | transloco"
                    icon="pi pi-save"
                    [loading]="savingSpawnregions"
                    [disabled]="!isSpawnregionsDirty"
                    (click)="saveSpawnregionsChanges()"
                  ></button>
                </div>
              </p-tabpanel>
            </p-tabpanels>
          </p-tabs>
        }
      </p-card>
    </div>
  </div>
</div>

@if (createDialogVisible) {
  <p-dialog [header]="'server.ui.createServerTitle' | transloco" [(visible)]="createDialogVisible" [modal]="true" [style]="{ width: '32rem', maxWidth: '95vw' }">
    <div class="p-fluid">
      <label for="new-server-name">{{ 'server.ui.serverName' | transloco }}</label>
      <br />
      <ul class="text-sm text-color-secondary mt-1 mb-2 pl-3 list-disc">
        <li class="ml-2">{{ 'server.ui.createServerHint' | transloco }}</li>
      </ul>
      <input
        id="new-server-name"
        type="text"
        pInputText
        [(ngModel)]="newServerName"
        autocomplete="off"
        class="w-full"
      />
      <div class="flex justify-content-end gap-2 mt-3">
        <button pButton type="button" [label]="'server.ui.cancel' | transloco" class="p-button-text" (click)="createDialogVisible = false"></button>
        <button pButton type="button" [label]="'server.ui.create' | transloco" icon="pi pi-check" (click)="confirmCreateServer()"></button>
      </div>
    </div>
  </p-dialog>
}

@if (copyDialogVisible) {
  <p-dialog [header]="'server.ui.copyServerTitle' | transloco" [(visible)]="copyDialogVisible" [modal]="true" [style]="{ width: '32rem', maxWidth: '95vw' }">
    <div class="p-fluid">
      <p class="text-color-secondary">
        {{ 'server.ui.copyServerPrompt' | transloco: { name: copySourceName || selectedServerName } }}
      </p>
      @if (copyServerFileNames.length) {
        <ul class="text-sm text-color-secondary mt-1 mb-2 pl-3 list-disc">
          @for (fileName of copyServerFileNames; track fileName) {
            <li class="ml-2">{{ fileName }}</li>
          }
        </ul>
      }
      <label for="copy-server-name">{{ 'server.ui.serverName' | transloco }}</label>
      <br />
      <input
        id="copy-server-name"
        type="text"
        pInputText
        [(ngModel)]="copyServerName"
        autocomplete="off"
        class="w-full"
      />
      <div class="flex justify-content-end gap-2 mt-3">
        <button pButton type="button" [label]="'server.ui.cancel' | transloco" class="p-button-text" (click)="copyDialogVisible = false"></button>
        <button pButton type="button" [label]="'server.ui.copy' | transloco" icon="pi pi-copy" (click)="confirmCopyServer()"></button>
      </div>
    </div>
  </p-dialog>
}

@if (editIniVisible) {
  <p-dialog [header]="'server.ui.editServerVariableTitle' | transloco" [(visible)]="editIniVisible" [modal]="true" [style]="{ width: '36rem', maxWidth: '95vw' }" (onHide)="cancelIniEdit()">
    @if (editIniLine) {
      <div class="p-fluid">
        <div class="text-lg font-medium">{{ formatIniLabel(editIniLine.key) }}</div>
        @if (editIniCommentLines.length) {
          <ul class="text-sm text-color-secondary mt-1 mb-0 pl-3 list-disc">
            @for (comment of editIniCommentLines; track comment) {
              <li class="ml-2">{{ comment }}</li>
            }
          </ul>
        }
      <div class="mt-3">
        @if (isWelcomeMessageKey(editIniLine.key)) {
          <textarea
            pTextarea
            rows="5"
            [(ngModel)]="editIniValue"
            class="w-full"
            style="font-family: var(--font-family-monospace, monospace)"
          ></textarea>
      } @else if (isBadWordListFileKey(editIniLine.key)) {
        <textarea
          pTextarea
          rows="3"
          [(ngModel)]="editIniValue"
          class="w-full"
          style="font-family: var(--font-family-monospace, monospace)"
        ></textarea>
      } @else if (isClientCommandFilterKey(editIniLine.key)) {
        <textarea
          pTextarea
          rows="4"
          [(ngModel)]="editIniValue"
          class="w-full"
          style="font-family: var(--font-family-monospace, monospace)"
        ></textarea>
      } @else if (isClientActionLogsKey(editIniLine.key)) {
        <textarea
          pTextarea
          rows="4"
          [(ngModel)]="editIniValue"
          class="w-full"
          style="font-family: var(--font-family-monospace, monospace)"
        ></textarea>
      } @else if (isBooleanValue(editIniValue)) {
          <div class="flex gap-3 align-items-center">
            @for (opt of booleanOptions; track opt.value) {
              <div class="flex align-items-center gap-2">
                <p-radioButton
                  name="edit-ini-boolean"
                  [value]="opt.value"
                  [(ngModel)]="editIniValue"
                  [inputId]="'edit-ini-' + opt.value"
                ></p-radioButton>
                <label [for]="'edit-ini-' + opt.value">{{ opt.label }}</label>
              </div>
            }
          </div>
      } @else if (isNumericValue(editIniValue)) {
        <p-inputNumber
          [(ngModel)]="editIniNumber"
          (ngModelChange)="onIniNumberChange($event)"
          [minFractionDigits]="editIniUsesDecimals ? 2 : 0"
          [maxFractionDigits]="2"
          [useGrouping]="false"
          styleClass="w-full"
          [inputStyle]="{ width: '100%' }"
        ></p-inputNumber>
        } @else {
          <input
            pInputText
            type="text"
            [(ngModel)]="editIniValue"
            class="w-full"
            style="font-family: var(--font-family-monospace, monospace)"
          />
        }
        </div>
        <div class="flex gap-2 mt-3">
          <button pButton type="button" [label]="'server.ui.cancel' | transloco" class="p-button-text" (click)="cancelIniEdit()"></button>
          <button pButton type="button" [label]="'server.ui.save' | transloco" class="p-button-warning" icon="pi pi-save" (click)="saveIniEdit()"></button>
        </div>
      </div>
    }
  </p-dialog>
}

@if (editSandboxVisible) {
  <p-dialog [header]="'server.ui.editSandboxVariableTitle' | transloco" [(visible)]="editSandboxVisible" [modal]="true" [style]="{ width: '36rem', maxWidth: '95vw' }" (onHide)="cancelSandboxEdit()">
    @if (editSandboxEntry) {
      <div class="p-fluid">
        <div class="text-lg font-medium">{{ formatSandboxLabel(editSandboxEntry.key) }}</div>
        @if (editSandboxEntry.commentLines.length) {
          <ul class="text-sm text-color-secondary mt-1 mb-0 pl-3 list-disc">
            @for (comment of editSandboxEntry.commentLines; track comment) {
              <li class="ml-2">{{ comment }}</li>
            }
          </ul>
        }
        <div class="mt-3">
          @if (isWorldItemRemovalListKey(editSandboxEntry.key)) {
            <textarea
              pTextarea
              rows="6"
              [(ngModel)]="editSandboxValue"
              class="w-full"
              style="font-family: var(--font-family-monospace, monospace)"
            ></textarea>
          } @else if (isBooleanValue(editSandboxValue)) {
            <div class="flex gap-3 align-items-center">
              @for (opt of booleanOptions; track opt.value) {
                <div class="flex align-items-center gap-2">
                  <p-radioButton
                    name="edit-sandbox-boolean"
                    [value]="opt.value"
                    [(ngModel)]="editSandboxValue"
                    [inputId]="'edit-sandbox-' + opt.value"
                  ></p-radioButton>
                  <label [for]="'edit-sandbox-' + opt.value">{{ opt.label }}</label>
                </div>
              }
            </div>
          } @else if (isNumericValue(editSandboxValue)) {
            <p-inputNumber
              [(ngModel)]="editSandboxNumber"
              (ngModelChange)="onSandboxNumberChange($event)"
              [minFractionDigits]="editSandboxUsesDecimals ? 2 : 0"
              [maxFractionDigits]="2"
              [useGrouping]="false"
              styleClass="w-full"
              [inputStyle]="{ width: '100%' }"
            ></p-inputNumber>
          } @else {
            <input
              pInputText
              type="text"
              [(ngModel)]="editSandboxValue"
              class="w-full"
              style="font-family: var(--font-family-monospace, monospace)"
            />
          }
        </div>
        <div class="flex gap-2 mt-3">
          <button pButton type="button" [label]="'server.ui.cancel' | transloco" class="p-button-text" (click)="cancelSandboxEdit()"></button>
          <button pButton type="button" [label]="'server.ui.save' | transloco" class="p-button-warning" icon="pi pi-save" (click)="saveSandboxEdit()"></button>
        </div>
      </div>
    }
  </p-dialog>
}

@if (deleteDialogVisible) {
  <p-dialog [header]="'server.ui.deleteServerTitle' | transloco" [(visible)]="deleteDialogVisible" [modal]="true" [style]="{ width: '30rem', maxWidth: '95vw' }">
    <div class="p-fluid">
      <p class="text-color-secondary">
        {{ 'server.ui.deleteServerPrompt' | transloco: { name: selectedServerName } }}
      </p>
      <div class="flex justify-content-end gap-2 mt-3">
        <button pButton type="button" [label]="'server.ui.cancel' | transloco" class="p-button-text" (click)="deleteDialogVisible = false"></button>
        <button pButton type="button" [label]="'server.ui.deleteServer' | transloco" icon="pi pi-trash" class="p-button-danger" [loading]="deletingServer" (click)="confirmDeleteServer()"></button>
      </div>
    </div>
  </p-dialog>
}

@if (modsDialogVisible) {
  <app-mods-picker-dialog
    [(visible)]="modsDialogVisible"
    [modsValue]="modsDialogModsValue"
    [workshopValue]="modsDialogWorkshopValue"
    (save)="onModsDialogSave($event)"
  ></app-mods-picker-dialog>
}
