<div class="p-3">
  <p-card header="Character Viewer & Editor">
    <div class="controls">
      <div class="field">
        <label for="pz-user-dir">Zomboid user folder</label>
        <input id="pz-user-dir" type="text" pInputText [(ngModel)]="userDir" [placeholder]="userDirPlaceholder"
          autocomplete="off" />
      </div>
      <div class="field">
        <label for="pz-media-dir">Project Zomboid media folder</label>
        <input id="pz-media-dir" type="text" pInputText [(ngModel)]="mediaDir"
          [placeholder]="mediaDirPlaceholder" autocomplete="off" (blur)="onMediaDirUpdated()" />
      </div>
      <div class="field">
        <label for="pz-mod-media-dir">Mod media override (optional)</label>
        <input id="pz-mod-media-dir" type="text" pInputText [(ngModel)]="modMediaDir"
          [placeholder]="modMediaDirPlaceholder" autocomplete="off" (blur)="onModMediaDirUpdated()" />
      </div>
      <div class="control-buttons">
        <button pButton type="button" label="Scan Saves" (click)="onScanSaves()"></button>
        <button pButton type="button" label="Browse players.db" (click)="onBrowseDb()"></button>
        <button pButton type="button" label="Browse media" (click)="onBrowseMediaDir()"></button>
        <button pButton type="button" label="Browse mod media" (click)="onBrowseModMediaDir()"></button>
        <button pButton type="button" label="Export JSON" (click)="onExportJson()"
          [disabled]="!selectedPlayer"></button>
        <button pButton type="button" label="Import JSON" (click)="onImportJson()"></button>
      </div>
      <div class="field">
        <label for="db-select">players.db</label>
        <select id="db-select" class="pz-select" [(ngModel)]="selectedDbPath" (change)="onDbSelected()">
          <option value="">Select a save</option>
          @for (option of dbOptions; track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>
      <div class="field">
        <label for="players-table">Players table</label>
        <select id="players-table" class="pz-select" [(ngModel)]="playersTableMode"
          (change)="onPlayersTableChanged()">
          <option value="auto">Auto</option>
          <option value="localPlayers">localPlayers</option>
          <option value="networkPlayers">networkPlayers</option>
        </select>
      </div>
      @if (errorMessage) {
      <p-message severity="error" [text]="errorMessage"></p-message>
      }
      @if (jsonImportError) {
      <p-message severity="warn" [text]="jsonImportError"></p-message>
      }
    </div>
    <p-table [value]="players" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,25,50]" dataKey="id">
      <ng-template pTemplate="header">
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>World</th>
          <th>Dead</th>
          <th>Coords</th>
          <th>Blob</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-player>
        <tr (click)="selectPlayer(player)" [class.selected]="selectedPlayer?.id === player.id">
          <td>{{ player.id }}</td>
          <td>{{ player.name || '(Unnamed)' }}</td>
          <td>{{ player.worldVersion }}</td>
          <td>
            <p-tag [value]="player.isDead ? 'Dead' : 'Alive'" [severity]="player.isDead ? 'danger' : 'success'"></p-tag>
          </td>
          <td>{{ player.x.toFixed(1) }}, {{ player.y.toFixed(1) }}, {{ player.z.toFixed(1) }}</td>
          <td>{{ player.dataLen }} bytes</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<div class="card">
  <div class="col-12">
    <p-card>
      <div class="grid players-grid">

        <div class="col-12 lg:col-6">
          <p-card header="Selected Player" class="player-editor">
            @if (!selectedPlayer) {
            <p-message severity="info" text="Select a player to view details."></p-message>
            } @else {
            <div class="editor-grid">
              <div class="field">
                <label>Presets</label>
                <div class="preset-row">
                  <button pButton type="button" label="Snap to Tile" (click)="applyPreset('snap')"></button>
                  <button pButton type="button" label="Ground Z=0" (click)="applyPreset('ground')"></button>
                  <button pButton type="button" label="Set Alive" (click)="applyPreset('alive')"></button>
                  <button pButton type="button" label="Set Dead" (click)="applyPreset('dead')"></button>
                  <button pButton type="button" label="Center 0,0,0" (click)="applyPreset('center')"></button>
                </div>
              </div>
              <div class="field toggle-field">
                <label for="safe-mode">Safe patch mode</label>
                <p-toggleswitch inputId="safe-mode" [(ngModel)]="safePatchMode"></p-toggleswitch>
              </div>
              <div class="field">
                <label for="player-name">Name</label>
                <input id="player-name" type="text" pInputText [(ngModel)]="draftName"
                  (ngModelChange)="onMetaChanged()" />
              </div>
              <div class="field">
                <label for="player-x">X</label>
                <input id="player-x" type="number" pInputText [(ngModel)]="draftX" (ngModelChange)="onMetaChanged()" />
              </div>
              <div class="field">
                <label for="player-y">Y</label>
                <input id="player-y" type="number" pInputText [(ngModel)]="draftY" (ngModelChange)="onMetaChanged()" />
              </div>
              <div class="field">
                <label for="player-z">Z</label>
                <input id="player-z" type="number" pInputText [(ngModel)]="draftZ" (ngModelChange)="onMetaChanged()" />
              </div>
              <div class="field toggle-field">
                <label for="player-dead">Dead</label>
                <p-toggleswitch inputId="player-dead" [(ngModel)]="draftIsDead"
                  (ngModelChange)="onMetaChanged()"></p-toggleswitch>
              </div>
              <div class="field">
                <label for="player-death-cause">Cause of Death</label>
                <input id="player-death-cause" type="text" pInputText [(ngModel)]="draftDeathCause"
                  (ngModelChange)="onMetaChanged()" />
              </div>
              <div class="field toggle-field">
                <label for="backup-enabled">Backup on save</label>
                <p-toggleswitch inputId="backup-enabled" [(ngModel)]="backupEnabled"></p-toggleswitch>
              </div>
            </div>

            <div class="button-row">
              <button pButton type="button" label="Apply Safe Patch" (click)="onApplySafePatch()"
                [disabled]="(!metaDirty && !hexDirty) || saving || !!hexError"></button>
              <button pButton type="button" label="Reload" (click)="onReloadPlayer()"
                [disabled]="loading || saving"></button>
              <button pButton type="button" label="Save Metadata" (click)="onSaveMetadata()"
                [disabled]="!metaDirty || saving"></button>
              <button pButton type="button" label="Save Blob" class="p-button-danger" (click)="onSaveBlob()"
                [disabled]="!hexDirty || saving || !!hexError"></button>
            </div>

            <p-message severity="warn"
              text="Editing the blob can corrupt saves. Keep backups and avoid changing hex unless you know the format."></p-message>
            @if (safePatchMode) {
            <p-message severity="info"
              text="Safe patch mode: blob edits are restricted to same-length string replacements."></p-message>
            }

            @if (hexError) {
            <p-message severity="warn" [text]="hexError"></p-message>
            }

            <div class="field">
              <label for="player-blob">Blob (hex, {{ dataByteLength }} bytes)</label>
              <textarea id="player-blob" pInputTextarea [(ngModel)]="draftDataHex" (ngModelChange)="onHexChanged()"
                rows="10" class="hex-area"></textarea>
            </div>

            <div class="field">
              <label>Hex Dump (jump to offset)</label>
              <div class="hex-tools">
                <input type="number" pInputText [(ngModel)]="hexDumpOffset" (change)="jumpToOffset()"
                  placeholder="Offset" />
                <input type="number" pInputText [(ngModel)]="hexDumpBytesPerRow" (change)="updateHexDump()"
                  placeholder="Bytes/row" />
                <input type="number" pInputText [(ngModel)]="hexDumpRows" (change)="updateHexDump()"
                  placeholder="Rows" />
                <button pButton type="button" label="Refresh" (click)="updateHexDump()"></button>
              </div>
              <textarea pInputTextarea [ngModel]="hexDumpText" rows="8" class="hex-area" readonly></textarea>
            </div>

            <div class="field">
              <label>Search Blob</label>
              <div class="hex-tools">
                <input type="text" pInputText [(ngModel)]="hexSearch" placeholder="Hex (e.g. 504C5952)" />
                <input type="text" pInputText [(ngModel)]="asciiSearch" placeholder="ASCII (e.g. Alan)" />
                <button pButton type="button" label="Search" (click)="onSearchBlob()"></button>
              </div>
              @if (searchResults.length) {
              <div class="search-results">
                @for (offset of searchResults; track offset) {
                <button pButton type="button" class="p-button-outlined" label="{{ '0x' + offset.toString(16) }}"
                  (click)="jumpToSearchOffset(offset)"></button>
                }
              </div>
              }
            </div>

            <div class="field">
              <label>Extracted strings (best-effort)</label>
              @if (!inspect?.strings?.length) {
              <p-message severity="info" text="No strings detected."></p-message>
              } @else {
              <p-table [value]="inspect?.strings ?? []" [rows]="6" [paginator]="true">
                <ng-template pTemplate="header">
                  <tr>
                    <th style="width: 80px">Offset</th>
                    <th style="width: 80px">Len</th>
                    <th>Value</th>
                    <th style="width: 160px">Edit</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-hit let-rowIndex="rowIndex">
                  <tr>
                    <td>{{ hit.offset }}</td>
                    <td>{{ hit.length }}</td>
                    <td>{{ hit.value }}</td>
                    <td>
                      <input type="text" pInputText [(ngModel)]="stringEdits[rowIndex]" placeholder="Same length" />
                      <button pButton type="button" label="Apply" (click)="applyStringHit(hit, rowIndex)"></button>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
              }
            </div>

            <div class="field">
              <label>JSON Preview</label>
              <textarea pInputTextarea [ngModel]="jsonPreview" rows="8" class="hex-area" readonly></textarea>
            </div>
            <div class="field">
              <label>Parsed Blob Summary</label>
              <textarea pInputTextarea [ngModel]="parsedBlobSummary" rows="12" class="hex-area"
                readonly></textarea>
            </div>

            <div class="field">
              <label>Blob Text (.bin)</label>
              @if (!blobTextFiles.length) {
              <p-message severity="info" text="No readable .bin text found."></p-message>
              } @else {
              <div class="blob-text-blocks">
                @for (file of blobTextFiles; track file.name) {
                <div class="blob-text-block">
                  <div><strong>{{ file.name }}</strong></div>
                  <textarea pInputTextarea [ngModel]="file.text" rows="6" class="hex-area" readonly></textarea>
                  @if (file.decodedText) {
                  <div><strong>Base64 Decoded</strong></div>
                  <textarea pInputTextarea [ngModel]="file.decodedText" rows="6" class="hex-area" readonly></textarea>
                  }
                </div>
                }
              </div>
              }
            </div>

            <div class="field">
              <label>JSON Diff</label>
              <div class="preset-row">
                <button pButton type="button" label="Load JSON A" (click)="loadDiffFile('a')"></button>
                <button pButton type="button" label="Load JSON B" (click)="loadDiffFile('b')"></button>
              </div>
              @if (diffMetaRows.length) {
              <p-table [value]="diffMetaRows" [rows]="8" [paginator]="true">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Field</th>
                    <th>JSON A</th>
                    <th>JSON B</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                  <tr [class.diff-changed]="row.changed">
                    <td>{{ row.field }}</td>
                    <td>{{ row.a }}</td>
                    <td>{{ row.b }}</td>
                  </tr>
                </ng-template>
              </p-table>
              <div class="diff-hash">
                <div>Blob Hash A: {{ diffHashA }}</div>
                <div>Blob Hash B: {{ diffHashB }}</div>
              </div>
              <p-table [value]="diffStringRows" [rows]="8" [paginator]="true">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Key</th>
                    <th>String A</th>
                    <th>String B</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                  <tr [class.diff-changed]="row.changed">
                    <td>{{ row.key }}</td>
                    <td>{{ row.a }}</td>
                    <td>{{ row.b }}</td>
                  </tr>
                </ng-template>
              </p-table>
              } @else {
              <textarea pInputTextarea [ngModel]="diffSummary" rows="6" class="hex-area" readonly></textarea>
              }
            </div>
            }
          </p-card>
        </div>
        <div class="col-12 lg:col-6">
          <p-card header="Avatar Preview" class="avatar-card">
            <div class="avatar-preview">
              <div #avatarHost class="avatar-host"></div>
              @if (visualError) {
              <p-message severity="warn" [text]="visualError"></p-message>
              }
              @if (avatarLogs.length) {
              <div class="avatar-logs">
                <div class="avatar-log-title">Asset log</div>
                <div class="avatar-log-lines">
                  @for (line of avatarLogs; track $index) {
                  <div>{{ line }}</div>
                  }
                </div>
              </div>
              }
              @if (visualProfile) {
              <div class="avatar-meta">
                <div><strong>Name</strong> {{ visualProfile.descriptor.forename }} {{ visualProfile.descriptor.surname }}</div>
                <div><strong>Sex</strong> {{ visualProfile.descriptor.female ? 'Female' : 'Male' }}</div>
                <div><strong>Hair</strong> {{ visualProfile.visual.hairModel || 'Default' }}</div>
                <div><strong>Beard</strong> {{ visualProfile.visual.beardModel || 'None' }}</div>
                <div><strong>Clothing</strong></div>
                <ul class="avatar-list">
                  @for (item of visualProfile.visual.items; track $index) {
                  <li>{{ item.fullType || item.clothingItemName || 'Unknown item' }}</li>
                  }
                </ul>
                @if (visualProfile.visual.bipedVisual; as bipedVisual) {
                <div><strong>Biped Model</strong></div>
                <ul class="avatar-list">
                  <li>Texture: {{ bipedVisual.texture }}</li>
                  <li>No Weapon: {{ bipedVisual.noWeapon }}</li>
                  <li>Model GUID: {{ bipedVisual.modelGuid }}</li>
                  @if (bipedVisual.primaryHandItem) {
                  <li>Primary Hand: {{ bipedVisual.primaryHandItem }}</li>
                  }
                  @if (bipedVisual.secondaryHandItem) {
                  <li>Secondary Hand: {{ bipedVisual.secondaryHandItem }}</li>
                  }
                </ul>
                }
              </div>
              }
            </div>
          </p-card>
        </div>
      </div>
    </p-card>
  </div>
</div>
